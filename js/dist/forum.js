(()=>{var t={535:t=>{"use strict";t.exports=flarum.extensions["fof-byobu"]}},a={};function e(r){var o=a[r];if(void 0!==o)return o.exports;var n=a[r]={exports:{}};return t[r](n,n.exports,e),n.exports}e.n=t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},e.d=(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},e.o=(t,a)=>Object.prototype.hasOwnProperty.call(t,a),e.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};(()=>{"use strict";e.r(r),e.d(r,{components:()=>vt,models:()=>yt,states:()=>bt,utils:()=>gt});const t=flarum.core.compat["common/extend"],a=flarum.core.compat["common/models/User"];var o=e.n(a);const n=flarum.core.compat["common/Model"];var s=e.n(n);const i=flarum.core.compat["common/utils/Stream"];var d=e.n(i);function c(t,a){return c=Object.setPrototypeOf||function(t,a){return t.__proto__=a,t},c(t,a)}function l(t,a){t.prototype=Object.create(a.prototype),t.prototype.constructor=t,c(t,a)}const u=flarum.core.compat["common/utils/ItemList"];var f=e.n(u);const p=flarum.core.compat["common/utils/mixin"],h=function(t,a){return Array.isArray(t)?t.map(a).sort():a(t)};var v=function(t){function a(){return t.apply(this,arguments)||this}return l(a,t),a}(e.n(p)()(s(),{user:s().hasOne("user"),content:s().attribute("content"),title:s().attribute("title"),scheduledValidationError:s().attribute("scheduledValidationError"),relationships:s().attribute("relationships"),extra:s().attribute("extra"),scheduledFor:s().attribute("scheduledFor",s().transformDate),updatedAt:s().attribute("updatedAt",s().transformDate),loadedRelationships:null,type:function(){var t=this.loadRelationships();return t.discussion?"reply":flarum.extensions["fof-byobu"]&&flarum.extensions["fof-byobu"].discussions&&("recipientGroups"in t||"recipientUsers"in t)?"privateDiscussion":"discussion"},icon:function(){switch(this.type()){case"discussion":return"fas fa-edit";case"reply":return"fas fa-reply";case"privateDiscussion":return app.forum.data.attributes["byobu.icon-badge"]||"fas fa-eye-slash"}},loadRelationships:function(t){var a=this;if(!t&&this.loadedRelationships&&(Object.keys(this.loadedRelationships).length>0||0===Object.keys(this.loadedRelationships).length&&0===Object.keys(this.relationships).length))return this.loadedRelationships;this.loadedRelationships={};var e=this.relationships();if(e&&Object.keys(e).forEach((function(t){var r=e[t];r&&r.data&&(a.loadedRelationships[t]=h(r.data,(function(t){return app.store.getById(t.type,t.id)})))})),"recipientUsers"in this.loadedRelationships||"recipientGroups"in this.loadedRelationships){var r=new(f());(this.loadedRelationships.recipientUsers||[]).forEach((function(t){t&&r.add("users:"+t.id(),t)})),(this.loadedRelationships.recipientGroups||[]).forEach((function(t){t&&r.add("groups:"+t.id(),t)})),this.loadedRelationships.recipients=r}return this.loadedRelationships},compileData:function(){var t={originalContent:this.content(),title:this.title(),user:app.session.user,confirmExit:app.translator.trans("fof-drafts.forum.composer.exit_alert"),draft:this,fields:Object.assign({},this.loadRelationships(),this.extra())};return Object.assign(t,t.fields),t}}));const y=flarum.core.compat["common/components/Page"];var b=e.n(y);const g=flarum.core.compat["common/Component"];var _=e.n(g);const w=flarum.core.compat["common/components/LoadingIndicator"];var D=e.n(w);const N=flarum.core.compat["common/components/Button"];var S=e.n(N);const A=flarum.core.compat["forum/app"];var x=e.n(A);const I=flarum.core.compat["common/helpers/avatar"];var F=e.n(I);const j=flarum.core.compat["common/helpers/icon"];var C=e.n(j);const k=flarum.core.compat["common/helpers/humanTime"];var E=e.n(k);const M=flarum.core.compat["common/utils/string"],O=flarum.core.compat["common/components/Tooltip"];var B=e.n(O),R=function(t){function a(){for(var a,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(a=t.call.apply(t,[this].concat(r))||this).canSchedule=x().forum.attribute("canScheduleDrafts")&&x().forum.attribute("drafts.enableScheduledDrafts"),a}l(a,t);var e=a.prototype;return e.oncreate=function(a){t.prototype.oncreate.call(this,a)},e.view=function(){var t=this.attrs,a=t.draft,e=t.state,r="far fa-calendar-plus";return a.scheduledValidationError()?r="far fa-calendar-times":a.scheduledFor()&&(r="far fa-calendar-check"),m("li",null,m("a",{onclick:e.showComposer.bind(e,a),className:"Notification draft--item"},F()(a.user()),C()(a.icon(),{className:"Notification-icon"}),m("span",{class:"Notification-title"},m("span",{className:"Notification-content"},a.scheduledFor()&&m(B(),{showOnFocus:!1,text:x().translator.trans("fof-drafts.forum.dropdown.scheduled_icon_tooltip",{datetime:dayjs(a.scheduledFor()).format(x().translator.trans("fof-drafts.forum.dropdown.scheduled_icon_tooltip_formatter")[0])})},C()("far fa-clock",{className:"draft--scheduledIcon"})),"reply"===a.type()?a.loadRelationships().discussion.title():a.title()),m("span",{class:"Notification-title-spring"}),E()(a.updatedAt())),m("div",{class:"Notification-action"},m(B(),{showOnFocus:!1,text:x().translator.trans("fof-drafts.forum.dropdown.delete_button")},m(S(),{"data-container":"body",icon:"fas fa-trash-alt",className:"Notification-action Button Button--link hasIcon draft--delete",onclick:function(t){e.deleteDraft(a),t.stopPropagation()}})),this.canSchedule?m(B(),{showOnFocus:!1,text:x().translator.trans("fof-drafts.forum.dropdown.schedule_button")},m(S(),{"data-container":"body",icon:r,className:"Notification-action Button Button--link hasIcon draft--schedule",onclick:function(t){e.scheduleDraft(a),t.stopPropagation()}})):null),m("div",{className:"Notification-excerpt"},(0,M.truncate)(a.content(),200)),a.scheduledValidationError()?m("p",{className:"scheduledValidationError"},a.scheduledValidationError()):""))},a}(_()),L=function(t){function a(){return t.apply(this,arguments)||this}l(a,t);var e=a.prototype;return e.oncreate=function(a){t.prototype.oncreate.call(this,a),$(".draft--delete").on("click tap",(function(t){t.stopPropagation()}))},e.deleteAll=function(){confirm(app.translator.trans("fof-drafts.forum.dropdown.delete_all_alert"))&&app.request({method:"DELETE",url:app.forum.attribute("apiUrl")+"/drafts/all"}).then((function(){app.store.data.drafts=[],m.redraw()}))},e.view=function(){var t=app.store.all("drafts"),a=this.attrs.state;return m("div",{className:"NotificationList DraftsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},app.translator.trans("fof-drafts.forum.dropdown.title")),m("div",{class:"App-primaryControl"},m(B(),{showOnFocus:!1,text:app.translator.trans("fof-drafts.forum.dropdown.delete_all_button")},m(S(),{"data-container":"body",icon:"fas fa-trash-alt",className:"Button Button--link Button--icon Alert-dismiss",onclick:this.deleteAll.bind(this)})))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},t.length?t.sort((function(t,a){return a.updatedAt()-t.updatedAt()})).map((function(t){return m(R,{draft:t,state:a})})):null,a.loading?m(D(),{display:"block"}):!t.length&&m("div",{className:"NotificationList-empty"},app.translator.trans("fof-drafts.forum.dropdown.empty_text")))))},a}(_()),P=function(t){function a(){return t.apply(this,arguments)||this}l(a,t);var e=a.prototype;return e.oninit=function(a){t.prototype.oninit.call(this,a),app.history.push("drafts"),app.drafts.load(),this.bodyClass="App--drafts"},e.view=function(){return m("div",{className:"DraftsPage"},m(L,{state:app.drafts}))},a}(b());const T=flarum.core.compat["common/app"];var V=e.n(T);const U=flarum.core.compat["common/components/HeaderSecondary"];var Y=e.n(U);const G=flarum.core.compat["common/components/NotificationsDropdown"];var H=function(t){function a(){return t.apply(this,arguments)||this}l(a,t),a.initAttrs=function(a){a.label=a.label||app.translator.trans("fof-drafts.forum.dropdown.tooltip"),a.icon=a.icon||"fas fa-edit",t.initAttrs.call(this,a)};var e=a.prototype;return e.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?L.component({state:this.attrs.state}):"")},e.goToRoute=function(){m.route.set(app.route("drafts"))},e.getUnreadCount=function(){return app.cache.draftsLoaded?app.store.all("drafts").length:app.store.all("drafts").length+app.session.user.draftCount()},e.getNewCount=function(){return this.getUnreadCount()},a}(e.n(G)());const z=flarum.core.compat["common/components/FieldSet"];var q=e.n(z);const J=flarum.core.compat["common/components/SettingsPage"];var K=e.n(J);const Q=flarum.core.compat["common/components/Switch"];var W=e.n(Q);const X=flarum.core.compat["common/components/Composer"];var Z=e.n(X);const tt=flarum.core.compat["components/DiscussionComposer"];var at=e.n(tt);const et=flarum.core.compat["common/components/ReplyComposer"];var rt=e.n(et);const ot=flarum.core.compat["common/states/ComposerState"];var nt=e.n(ot);const st=flarum.core.compat["components/ReplyComposer"];var it=e.n(st);const dt=flarum.core.compat["common/components/Alert"];var ct=e.n(dt);const lt=flarum.core.compat["common/components/Modal"];var ut=e.n(lt),ft=dayjs().format("YYYY-MM-DD"),pt=dayjs().format("HH:mm"),mt=function(t){function a(){for(var a,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return(a=t.call.apply(t,[this].concat(r))||this).loading=!1,a.date=void 0,a.time=void 0,a.previewFormatString=void 0,a}l(a,t);var e=a.prototype;return e.oninit=function(a){t.prototype.oninit.call(this,a),this.date=this.isScheduled()?dayjs(this.attrs.draft.scheduledFor()).format("YYYY-MM-DD"):ft,this.time=this.isScheduled()?dayjs(this.attrs.draft.scheduledFor()).format("HH:mm"):pt,this.previewFormatString=app.translator.trans("fof-drafts.forum.schedule_draft_modal.schedule_time_preview_formatter")[0]},e.className=function(){return"ScheduleDraftModal"},e.title=function(){return app.translator.trans("fof-drafts.forum.schedule_draft_modal.title")},e.content=function(){var t=this;return this.loading?m(D(),null):[this.attrs.draft.scheduledFor()?m("div",{className:"Modal-alert"},m(ct(),{type:"success",dismissible:!1},app.translator.trans("fof-drafts.forum.schedule_draft_modal.scheduled_text",{datetime:this.formattedDateTime()}))):"",this.attrs.draft.scheduledValidationError()?m("div",{className:"Modal-alert"},m(ct(),{type:"error",dismissible:!1},app.translator.trans("fof-drafts.forum.schedule_draft_modal.scheduled_error",{error:this.attrs.draft.scheduledValidationError()}))):"",m("input",{style:"display: none"}),m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},app.translator.trans("fof-drafts.forum.schedule_draft_modal.text")),m("div",{className:"Form-group ScheduleDraftModal-timeDateGroup"},m("input",{name:"scheduledForDate",className:"FormControl",type:"date",min:ft,value:this.date,onchange:function(a){return t.date=a.target.value}}),m("input",{name:"scheduledForTime",className:"FormControl",type:"time",value:this.time,onchange:function(a){return t.time=a.target.value}})),m("div",{class:"Form-group ScheduleDraftModal-datePreview"},app.translator.trans("fof-drafts.forum.schedule_draft_modal.schedule_time_preview",{datetime:this.formattedDateTime()})),m("div",{className:"Form-group ScheduleDraftModal-submitButtons"},this.isScheduled()&&m(S(),{className:"ScheduleDraftModal-unscheduleBtn Button Button--block Button--danger",loading:this.loading,onclick:this.unschedule.bind(this)},app.translator.trans("fof-drafts.forum.schedule_draft_modal.unschedule_button")),m(S(),{className:"ScheduleDraftModal-scheduleBtn Button Button--block Button--primary",type:"submit",loading:this.loading,disabled:!this.changed()},this.isScheduled()?app.translator.trans("fof-drafts.forum.schedule_draft_modal.reschedule_button"):app.translator.trans("fof-drafts.forum.schedule_draft_modal.schedule_button")))))]},e.scheduledFor=function(){return new Date(this.date+" "+this.time)||null},e.changed=function(){var t=function(t){return t&&t.getTime()||null};return t(this.scheduledFor())!==t(this.attrs.draft.scheduledFor())},e.isScheduled=function(){return!!this.attrs.draft.scheduledFor()},e.formattedDateTime=function(){return dayjs(this.scheduledFor()).format(this.previewFormatString)},e.unschedule=function(t){var a=this;t.preventDefault(),this.loading=!0,confirm(app.translator.trans("fof-drafts.forum.schedule_draft_modal.unschedule_warning"))&&this.attrs.draft.save({scheduledFor:null,clearValidationError:!0,scheduledValidationError:""}).then((function(){a.success=!0,a.hide.call(a)})).catch((function(){})).then(this.loaded.bind(this))},e.onsubmit=function(t){var a=this;t.preventDefault(),this.loading=!0,this.attrs.draft.save({scheduledFor:this.scheduledFor(),clearValidationError:!0,scheduledValidationError:""}).then((function(){return a.success=!0})).catch((function(){})).then(this.loaded.bind(this))},a}(ut()),ht=function(){function t(t){this.app=t,this.loading=!1,this.cache=[]}var a=t.prototype;return a.deleteDraft=function(t){var a=this;window.confirm(app.translator.trans("fof-drafts.forum.dropdown.alert"))&&(this.loading=!0,t.delete().then((function(){app.composer.body&&app.composer.draft&&app.composer.draft.id()===t.id()&&!app.composer.changed()&&app.composer.hide(),a.loading=!1,m.redraw()})))},a.scheduleDraft=function(t){app.forum.attribute("canScheduleDrafts")&&app.forum.attribute("drafts.enableScheduledDrafts")&&app.modal.show(mt,{draft:t})},a.showComposer=function(t){if(!this.loading)return new Promise((function(a){var r;switch(t.type()){case"privateDiscussion":r=e(535).discussions.PrivateDiscussionComposer;break;case"reply":r=it();break;default:r=at()}var o=t.compileData();return app.composer.load(r,o),app.composer.show(),Object.assign(app.composer.fields,o.fields),a(app.composer)}))},a.load=function(){var t=this;app.cache.draftsLoaded||(this.loading=!0,m.redraw(),app.store.find("drafts").then((function(){return app.cache.draftsLoaded=!0}),(function(){})).then((function(){t.loading=!1,m.redraw()})))},t}(),vt={DraftsDropdown:H,DraftsList:L,DraftsListItem:R,DraftsPage:P,ScheduleDraftModal:mt},yt={Draft:v},bt={DraftsListState:ht},gt={fillRelationship:h};function _t(t,a){(null==a||a>t.length)&&(a=t.length);for(var e=0,r=new Array(a);e<a;e++)r[e]=t[e];return r}app.initializers.add("fof-drafts",(function(){function a(){var t=this;Object.keys(this.attrs).forEach((function(a){["originalContent","title","user"].includes(a)?"title"===a&&(t.title=d()(t.attrs.title)):t[a]=t.attrs[a]})),this.data&&(this.composer.data=this.data.bind(this)),this.attrs.draft&&(this.composer.draft=this.attrs.draft)}function e(){this.composer.draft&&this.composer.draft.delete()}app.store.models.drafts=v,o().prototype.drafts=s().hasMany("drafts"),o().prototype.draftCount=s().attribute("draftCount"),app.routes.drafts={path:"/drafts",component:P},app.drafts=new ht(app),nt().prototype.changed=function(){var t=this;if(!this.body||!this.data)return!1;var a=this.data(),e=this.draft,r=Object.keys(a).filter((function(t){return"relationships"!==t}));if(!r)return!1;if(!this.fields.content())return!1;for(var o,n=function(e){return("content"===e?t.fields.content():a[e])||""},s=function(t,a){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,a){if(t){if("string"==typeof t)return _t(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_t(t,a):void 0}}(t))||a&&t&&"number"==typeof t.length){e&&(t=e);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(r);!(o=s()).done;){var i=o.value;if(!e&&n(i)||e&&n(i)!=e.data.attributes[i])return!0}if(!a.relationships&&!e.relationships())return!1;for(var d=function(t,a,e){if(!(t.relationships[e]&&t.relationships[e].length||e in a.relationships()&&a.relationships()[e].data.length))return!0;if(!(e in a.relationships())||t.relationships[e].length!==a.relationships()[e].data.length)return!1;var r=function(t){return"function"==typeof t.id?t.id():t.id},o=h(t.relationships[e],r),n=h(a.relationships()[e].data,r);return!o.some((function(t,a){return t!==n[a]}))},c=0,l=Object.keys(a.relationships);c<l.length;c++){var u=l[c];if(e){if(!d(a,e,u))return!0}else if(a.relationships[u])return!0}return!1},nt().prototype.saveDraft=function(){var t=this;this.saving=!0,m.redraw();var a=function(){t.saving=!1,t.justSaved=!0,setTimeout((function(){t.justSaved=!1,m.redraw()}),300),m.redraw()},e=this.draft;e&&e.id()&&!e.exists||(e?(delete e.data.attributes.relationships,e.save(Object.assign(e.data.attributes,this.data())).then((function(){return a()}))):app.store.createRecord("drafts").save(this.data()).then((function(e){e.loadRelationships(!0),t.draft=e,a()})))},(0,t.extend)(Z().prototype,"controlItems",(function(t){if((this.state.bodyMatches(at())||this.state.bodyMatches(rt()))&&app.forum.attribute("canSaveDrafts")&&"minimized"!==this.state.position){var a=["Button","Button--icon","Button--link"];this.state.saving&&a.push("saving"),this.state.justSaved&&a.push("justSaved"),t.add("save-draft",S().component({icon:this.state.justSaved?"fas fa-check":this.state.saving?"fas fa-spinner fa-spin":"fas fa-save",className:a.join(" "),itemClassName:"App-backControl",title:app.translator.trans("fof-drafts.forum.composer.title"),disabled:this.state.saving||this.state.justSaved||this.loading,onclick:this.state.saveDraft.bind(this.state)}),20)}})),(0,t.extend)(nt().prototype,"load",(function(){var t=this;app.forum.attribute("canSaveDrafts")&&app.session.user.preferences().draftAutosaveEnable&&(this.bodyMatches(at())||this.bodyMatches(rt()))&&(this.autosaveInterval=setInterval((function(){!t.changed()||t.saving||t.loading||t.saveDraft()}),1e3*app.session.user.preferences().draftAutosaveInterval))})),(0,t.extend)(nt().prototype,"clear",(function(){this.draft=null,this.autosaveInterval&&clearInterval(this.autosaveInterval)})),(0,t.override)(nt().prototype,"preventExit",(function(t){this.body&&this.body.componentClass&&this.draft&&(this.body.attrs.confirmExit=app.translator.trans("fof-drafts.forum.composer.exit_alert"));var a=!1;if(this.changed()&&(a=t()),a)return a;if(this.body&&this.body.componentClass){var e=this.draft;return e&&!e.title()&&!e.content()&&confirm(app.translator.trans("fof-drafts.forum.composer.discard_empty_draft_alert"))&&e.delete(),a}})),(0,t.extend)(at().prototype,"oninit",a),(0,t.extend)(rt().prototype,"oninit",a),(0,t.extend)(at().prototype,"onsubmit",e),(0,t.extend)(rt().prototype,"onsubmit",e),(0,t.extend)(Y().prototype,"items",(function(t){V().session.user&&V().forum.attribute("canSaveDrafts")&&t.add("Drafts",m(H,{state:V().drafts}),20)})),(0,t.extend)(K().prototype,"oninit",(function(){this.draftAutosaveInterval=d()(this.user.preferences().draftAutosaveInterval)})),(0,t.extend)(K().prototype,"settingsItems",(function(t){app.forum.data.attributes.canSaveDrafts&&t.add("drafts",q().component({label:app.translator.trans("fof-drafts.forum.user.settings.drafts_heading"),className:"Settings-drafts"},this.draftsItems().toArray()))})),K().prototype.draftsItems=function(){var t=this,a=new(f());return a.add("draft-autosave-enable",W().component({state:this.user.preferences().draftAutosaveEnable,onchange:function(a){t.draftAutosaveEnableLoading=!0,t.user.savePreferences({draftAutosaveEnable:a}).then((function(){t.draftAutosaveEnableLoading=!1,m.redraw()}))},loading:this.draftAutosaveEnableLoading},app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_enable"))),a.add("draft-autosave-interval",this.user.preferences().draftAutosaveEnable?m("label",null,m("p",null,app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_interval_label")),m("input",{className:"FormControl",type:"number",min:"0",bidi:this.draftAutosaveInterval}),S().component({className:"Button Button--primary",onclick:function(){var a;t.draftAutosaveInterval()<0||(a=t.draftAutosaveInterval())!=Math.round(a)?(t.draftAutosaveIntervalInvalid=!0,t.draftAutosaveInterval(t.user.preferences().draftAutosaveInterval),m.redraw()):(t.draftAutosaveIntervalInvalid=!1,t.user.savePreferences({draftAutosaveInterval:t.draftAutosaveInterval()}).then((function(){m.redraw()})))}},app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_interval_button")),this.draftAutosaveIntervalInvalid?m("p",{class:"invalidInterval"},m("small",null,app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_interval_invalid"))):""):m("p",null)),a}}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map